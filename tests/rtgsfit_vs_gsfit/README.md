# rtgsfit_vs_gsfit

`rtgsfit_vs_gsfit` is a sub-repository within the `tests/` directory of the `rtgsfit` project.  
It provides automated tests to verify that results from `rtgsfit` are consistent with those from `gsfit` for ST40 pulses.

## Installation

```bash
uv venv --python 3.13
source .venv/bin/activate
uv pip install -e .
uv pip install /home/alex.prokopyszyn/my_mdsplus/python/MDSplus/.
uv pip install "numpy<2"
```

## Repository Structure

- **`data/`**  
  Initially contains only `default_config.json`. This directory will also hold `.npy` data files generated by `replay_rtgsfit`.

- **`plots/`**  
  Initially empty. This directory will store plots comparing RTGSFIT and GSFIT results.

- **`src/rtgsfit_vs_gsfit/`**  
  Contains the core Python modules:

  - `config_loader.py`  
    Defines `load_and_prepare_config()`, which loads `default_config.json` from the `data/` directory and returns a configuration dictionary (`cfg`) with details such as pulse number, run name, resolution, etc.

  - `prep_meas_coil_curr.py`  
    Contains `prep_meas()` and `prep_coil_curr()` which read measurement data from MAG and PSU2COIL on MDS+ to supply inputs for `replay_rtgsfit()`.

  - `replay_gsfit.py`  
    Defines `replay_gsfit()`, which sets up and runs GSFIT for the specified pulse and time in `cfg`, then saves the results to MDS+.

  - `replay_rtgsfit.py`  
    Defines `replay_rtgsfit()`, which runs RTGSFIT over multiple iterations. It requires the RTGSFIT code to be pre-compiled. This module uses `prep_meas` and `prep_coil_curr` from `prep_meas_coil_curr.py` to prepare input arrays, then outputs results as `.npy` files in the `data/` directory.

  - `rtgsfit_compile_setup.py`  
    Provides functions to interface with MDS+ and compile RTGSFIT:  
    - `rtgsfit_mds_nodeclear()` delete existing MDS+ node for RTGSFIT. 
    - `initialise_rtgsfit_node()` generates and populates the MDS+ node with the required data. 
    - `compile_rtgsfit()` compiles the RTGSFIT code using the `Makefile`.

  - `rtgsfit_pred_meas.py`  
    Contains `calc_pred_meas()`, which uses the `flux_norm`, `coef`, and `coil_curr` arrays, along with the appropriate Green's matrices, to determine the best-fit measurement values.


- **`src/rtgsfit_vs_gsfit/plot/`**  
  Contains modules for plotting data produced by `replay_gsfit` and `replay_rtgsfit`:  
  - `components.py`  
    Provides reusable subplot helper functions that take an `ax` argument and draw individual plot elements such as contours or annotations.
  - `examples.py`  
    Contains full example plotting routines that assemble the subplot components into complete figures.

- **`src/rtgsfit_vs_gsfit/table/`**
  Contains modules for producing formatted csv tables of the data produced by `replay_gsfit` and `replay_rtgsfit`:
  - `dataframes.py`  
    Makes Pandas Dataframe objects of the data.
  - `save_to_csv.py`  
    Combines Pandas Dataframes together into a CSV and formats them to make them more readable.

- **`tests/test_integration_rtgsfit_vs_gsfit.py`**  
  Implements `test_rtgsfit_vs_gsfit(pulse, time)`, which initializes, compiles, and runs both RTGSFIT and GSFIT for various pulse numbers and time snapshots. The tests compare results to ensure agreement and are designed for parallel execution across multiple CPUs. It also runs a regression test.

- **`pyproject.toml`**  
  Contains project metadata including Python package dependencies.

## Tests

To run the tests use 
```
pytest -n auto tests
```
to automaitcally detect available CPU cores or
```
pytest -n 4 tests
``` 
to use e.g. 4 cores.