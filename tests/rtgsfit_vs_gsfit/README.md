# rtgsfit_vs_gsfit

`rtgsfit_vs_gsfit` is a sub-repository within the `tests/` directory of the `rtgsfit` project.  
It provides automated tests to verify that results from `rtgsfit` are consistent with those from `gsfit` for ST40 pulses.

## Installation

```bash
uv venv --python 3.13
source .venv/bin/activate
uv pip install -e .
uv pip install /home/alex.prokopyszyn/my_mdsplus/python/MDSplus/.
uv pip install "numpy<2"
```

## Repository Structure

- **`data/`**  
  Initially contains only `default_config.json`. This directory will also hold `.npy` data files generated by `replay_rtgsfit`.

- **`plots/`**  
  Initially empty. This directory will store plots comparing RTGSFIT and GSFIT results.

- **`src/rtgsfit_vs_gsfit/`**  
  Contains the core Python modules:

  - `config_loader.py`  
    Defines `load_config()`, which loads `default_config.json` from the `data/` directory and returns a configuration dictionary (`cfg`) with details such as pulse number, run name, resolution, etc.

  - `replay_gsfit.py`  
    Defines `replay_gsfit()`, which sets up and runs GSFIT for the specified pulse and time in `cfg`, then saves the results to MDS+.

  - `replay_rtgsfit.py`  
    Defines `replay_rtgsfit()`, which runs RTGSFIT over multiple iterations. It requires the RTGSFIT code to be pre-compiled. This module uses `prep_meas` and `prep_coil_curr` from `rtgsfit_signalprep.py` to prepare input arrays, then outputs results as `.npy` files in the `data/` directory.

  - `rtgsfit_compile_setup.py`  
    Provides functions to interface with MDS+ and compile RTGSFIT:  
    - `rtgsfit_mds_nodegen()` creates a node on MDS+.  
    - `initialise_rtgsfit_node()` populates the node with necessary data.  
    - `compile_rtgsfit()` compiles the RTGSFIT code using the `Makefile`.

  - `rtgsfit_signalprep.py`  
    Contains `prep_meas()` and `prep_coil_curr()` which read measurement data from MAG and PSU2COIL on MDS+ to supply inputs for `replay_rtgsfit()`.

- **`src/rtgsfit_vs_gsfit/plot/`**  
  Contains modules for plotting data produced by `replay_gsfit` and `replay_rtgsfit`.

- **`tests/test_rtgsfit_vs_gsfit.py`**  
  Implements `test_rtgsfit_vs_gsfit(pulse, time)`, which initializes, compiles, and runs both RTGSFIT and GSFIT for various pulse numbers and time snapshots. The tests compare results to ensure agreement and are designed for parallel execution across multiple CPUs.

- **`pyproject.toml`**  
  Contains project metadata including Python package dependencies.

## Tests

To run the tests use 
```
pytest -n auto tests
```
to automaitcally detect available CPU cores or
```
pytest -n 4 tests
``` 
to use e.g. 4 cores.